[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid

[program:app-key]
command=/bin/sh -lc 'set -e; if [ "$APP_ENV" = "production" ]; then rm -f .env; fi; if [ -z "$APP_KEY" ]; then if [ -f .env ]; then if ! grep -q "^APP_KEY=base64:" .env; then php artisan key:generate --force; fi; fi; fi; php artisan config:clear || true && php artisan config:cache || true'
autostart=true
autorestart=false
startsecs=0
exitcodes=0
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=1

[program:storage-link]
command=/bin/sh -lc 'set -e; \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ”— [storage-link] Iniciando..."; \
    cd /app; \
    \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ“ Verificando directorios..."; \
    ls -ld storage/app/public 2>/dev/null && echo "[$(date +'%Y-%m-%d %H:%M:%S')] âœ… [storage-link] Directorio storage/app/public existe" || echo "[$(date +'%Y-%m-%d %H:%M:%S')] âš ï¸ [storage-link] Directorio storage/app/public NO existe"; \
    \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ—‘ï¸ Eliminando symlink anterior (si existe)..."; \
    php artisan storage:unlink 2>&1 | sed "s/^/[$(date +'"'"'%Y-%m-%d %H:%M:%S'"'"')] [storage-link] /g" || echo "[$(date +'%Y-%m-%d %H:%M:%S')] [storage-link] No habÃ­a symlink anterior (es normal)"; \
    \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ”— Creando symlink storage:link..."; \
    php artisan storage:link 2>&1 | sed "s/^/[$(date +'"'"'%Y-%m-%d %H:%M:%S'"'"')] [storage-link] /g" || (echo "[$(date +'%Y-%m-%d %H:%M:%S')] âŒ [storage-link] Error al crear symlink!" && exit 1); \
    \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ“ Verificando symlink..."; \
    if [ -L public/storage ]; then \
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] âœ… [storage-link] Symlink creado correctamente: $(readlink -f public/storage)"; \
    else \
        echo "[$(date +'%Y-%m-%d %H:%M:%S')] âŒ [storage-link] El symlink public/storage NO existe!"; \
        exit 1; \
    fi; \
    \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ” Ajustando permisos..."; \
    chmod -R 777 storage/ public/bootstrap/cache 2>&1 | sed "s/^/[$(date +'"'"'%Y-%m-%d %H:%M:%S'"'"')] [storage-link] /g"; \
    \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ“Š Estado final de permisos:"; \
    ls -ld storage/ | sed "s/^/[$(date +'"'"'%Y-%m-%d %H:%M:%S'"'"')] [storage-link] /g"; \
    ls -ld public/storage | sed "s/^/[$(date +'"'"'%Y-%m-%d %H:%M:%S'"'"')] [storage-link] /g"; \
    ls -ld public/bootstrap/cache | sed "s/^/[$(date +'"'"'%Y-%m-%d %H:%M:%S'"'"')] [storage-link] /g"; \
    \
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] âœ… [storage-link] Â¡Completado exitosamente!"'
autostart=true
autorestart=false
startsecs=0
exitcodes=0
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=5

[program:php-fpm]
command=php-fpm
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:nginx]
command=nginx -g "daemon off;" -c /app/nginx.conf
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20
