[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid

[program:app-key]
command=/bin/sh -lc 'set -e; if [ "$APP_ENV" = "production" ]; then rm -f .env; fi; if [ -z "$APP_KEY" ]; then if [ -f .env ]; then if ! grep -q "^APP_KEY=base64:" .env; then php artisan key:generate --force; fi; fi; fi; php artisan config:clear || true && php artisan config:cache || true'
autostart=true
autorestart=false
startsecs=0
exitcodes=0
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=1

[program:permissions-fix]
command=/bin/sh -lc 'echo "ðŸ” [permissions-fix] Verificando permisos en runtime..."; cd /app; chmod -R 777 storage/ public/bootstrap/cache public/build 2>/dev/null || true; echo "âœ… [permissions-fix] Permisos ajustados: storage/=777"; echo "ðŸ“ [permissions-fix] Verificando directorios de almacenamiento:"; for dir in storage/app/public/clientes storage/app/public/empresas storage/app/public/productos; do if [ -d "$dir" ]; then echo "   âœ… $dir existe"; else mkdir -p "$dir" && chmod 777 "$dir" && echo "   âœ… $dir creado"; fi; done; echo "âœ… [permissions-fix] Â¡Completado!"'
autostart=true
autorestart=false
startsecs=0
exitcodes=0
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=3

[program:sync-storage-files]
command=/bin/sh -c 'echo "ðŸ“¦ [SYNC-STORAGE] Sincronizando TODOS los archivos de storage/app/public..."; cd /app; echo "   Origen: /app/storage/app/public/ (cÃ³digo de Git)"; echo "   Destino: /app/storage/app/public/ (volumen persistente)"; echo ""; echo "   Copiando TODOS los archivos recursivamente..."; cp -rv storage/app/public/* /app/storage/app/public/ 2>&1 | grep -E "^|-> " | head -50 || true; echo ""; echo "   Verificando directorios creados:"; find /app/storage/app/public -maxdepth 1 -type d ! -name "public" -exec basename {} \; | sort | sed "s/^/   âœ… /"; echo ""; echo "   Contando archivos totales:"; TOTAL=$(find /app/storage/app/public -type f | wc -l); echo "   âœ… Total de archivos: $TOTAL"; echo ""; echo "ðŸ” Estableciendo permisos finales (777)..."; chmod -R 777 /app/storage/app/public; echo "âœ… [SYNC-STORAGE] Â¡SincronizaciÃ³n completada exitosamente!"'
autostart=true
autorestart=false
startsecs=0
exitcodes=0
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=4

[program:storage-link]
command=/bin/sh -lc 'set -e; echo "ðŸ”— [storage-link] Iniciando..."; cd /app; echo "ðŸ“ Verificando directorios..."; test -d storage/app/public && echo "âœ… storage/app/public existe" || (mkdir -p storage/app/public && echo "âœ… storage/app/public creado"); echo "ðŸ—‘ï¸ Eliminando symlink antiguo SIN PIEDAD..."; rm -rf public/storage 2>/dev/null || true; unlink public/storage 2>/dev/null || true; echo "âœ… Symlink anterior eliminado"; echo "ðŸ”— Creando nuevo symlink..."; ln -s /app/storage/app/public public/storage && echo "âœ… Symlink creado manualmente" || (php artisan storage:link 2>&1 && echo "âœ… Symlink creado con artisan" || (echo "âŒ Error al crear symlink!" && exit 1)); echo "ðŸ“ Verificando symlink..."; if [ -L public/storage ]; then target=$(readlink -f public/storage); echo "âœ… Symlink vÃ¡lido: public/storage â†’ $target"; [ -d "$target" ] && echo "âœ… Directorio destino existe" || (echo "âš ï¸ Destino no existe, creando..." && mkdir -p "$target"); else echo "âŒ Symlink NO existe!"; exit 1; fi; echo "ðŸ” Permisos finales..."; chmod -R 777 storage/ public/bootstrap/cache 2>/dev/null || true; echo "âœ… [storage-link] Â¡Completado exitosamente!"'
autostart=true
autorestart=false
startsecs=0
exitcodes=0
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=5

[program:php-fpm]
command=php-fpm
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:nginx]
command=nginx -g "daemon off;" -c /app/nginx.conf
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20
