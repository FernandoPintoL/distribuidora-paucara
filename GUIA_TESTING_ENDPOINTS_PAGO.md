# üß™ GU√çA DE TESTING - ENDPOINTS DE PAGO Y CONFIRMACI√ìN

**Fecha:** 2025-10-25
**Status:** ‚úÖ Implementaci√≥n Completa
**Tiempo Estimado:** 1 hora para probar todos los endpoints

---

## üìã Resumen de Endpoints Nuevos

| Endpoint | M√©todo | Funci√≥n | Tiempo |
|----------|--------|---------|--------|
| `/api/app/proformas/{id}/confirmar` | POST | Confirmar proforma ‚Üí Crear venta | 15 min |
| `/api/app/ventas/{id}/pagos` | POST | Registrar pago en venta | 20 min |
| Validaci√≥n en `/programar` | GET | Verificar pago antes de env√≠o | 10 min |

**Total Testing:** ~45 minutos

---

## üîê CREDENCIALES DE PRUEBA

Usar cualquiera de estos usuarios cliente (ya creados):

```
Usuario 1:
Email: juan.perez@paucara.test
Password: password123

Usuario 2:
Email: maria.gonzalez@paucara.test
Password: password123

Usuario 3:
Email: carlos.ruiz@paucara.test
Password: password123
```

---

## üöÄ PASO 1: LOGIN Y OBTENER TOKEN

### Request
```bash
curl -X POST http://localhost:8000/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "juan.perez@paucara.test",
    "password": "password123"
  }'
```

### Response (Guardar el token)
```json
{
  "success": true,
  "data": {
    "token": "YOUR_TOKEN_HERE",
    "user": {
      "id": 1,
      "name": "Juan P√©rez",
      "email": "juan.perez@paucara.test"
    }
  }
}
```

**Importante:** Copiar el `token` para usarlo en las siguientes peticiones

---

## üìù PASO 2: CREAR UNA PROFORMA (Requisito)

Primero necesitas una proforma APROBADA para poder confirmarla.

### 2.1 Crear Proforma
```bash
curl -X POST http://localhost:8000/api/app/pedidos \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "items": [
      {"producto_id": 1, "cantidad": 5},
      {"producto_id": 2, "cantidad": 3},
      {"producto_id": 3, "cantidad": 2},
      {"producto_id": 4, "cantidad": 4},
      {"producto_id": 5, "cantidad": 1}
    ],
    "direccion_id": 1,
    "observaciones": "Pedido de prueba"
  }'
```

### Response
```json
{
  "success": true,
  "data": {
    "pedido": {
      "id": 42,
      "codigo": "PRF-2025-00152",
      "estado": "PENDIENTE",
      "total": 1500.00,
      "items": [...]
    }
  }
}
```

**Guardar:** Proforma ID (ej: 42) y n√∫mero

### 2.2 Aprobar Proforma (Necesita Dashboard o Artisan)

Para aprobar, acceder al dashboard web con usuario administrativo o usar:

```bash
php artisan tinker
> Proforma::find(42)->aprobar(User::find(1), 'Aprobada para testing')
```

---

## ‚úÖ PASO 3: CONFIRMAR PROFORMA ‚Üí CREAR VENTA

### Test 1: Validaci√≥n - Proforma no aprobada
```bash
curl -X POST "http://localhost:8000/api/app/proformas/42/confirmar" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "politica_pago": "MEDIO_MEDIO"
  }'
```

**Resultado esperado:** ‚ùå Error 422
```json
{
  "success": false,
  "message": "La proforma debe estar aprobada para confirmarla",
  "estado_actual": "PENDIENTE"
}
```

### Test 2: Validaci√≥n - Menos de 5 productos
*Crear proforma con solo 4 productos y aprobar*

```bash
curl -X POST "http://localhost:8000/api/app/proformas/41/confirmar" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "politica_pago": "MEDIO_MEDIO"
  }'
```

**Resultado esperado:** ‚ùå Error 422
```json
{
  "success": false,
  "message": "Debe solicitar m√≠nimo 5 productos diferentes",
  "productos_solicitados": 4,
  "productos_requeridos": 5
}
```

### Test 3: ‚úÖ √âXITO - Confirmar proforma aprobada (5+ productos)
```bash
curl -X POST "http://localhost:8000/api/app/proformas/42/confirmar" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "politica_pago": "MEDIO_MEDIO"
  }'
```

**Resultado esperado:** ‚úÖ Success 201
```json
{
  "success": true,
  "message": "Proforma PRF-2025-00152 confirmada como venta V-2025-00042",
  "data": {
    "venta": {
      "id": 42,
      "numero": "V-2025-00042",
      "fecha": "2025-10-25",
      "monto_total": 1500.00,
      "monto_pagado": 0,
      "monto_pendiente": 1500.00,
      "politica_pago": "MEDIO_MEDIO",
      "estado_pago": "PENDIENTE",
      "estado_logistico": "PENDIENTE_ENVIO"
    },
    "cliente": {
      "id": 1,
      "nombre": "Juan P√©rez Mart√≠nez"
    },
    "items_count": 5
  }
}
```

**Guardar:** Venta ID (42) para las siguientes pruebas

---

## üí≥ PASO 4: REGISTRAR PAGOS EN LA VENTA

### Test 1: Validaci√≥n - Monto negativo
```bash
curl -X POST "http://localhost:8000/api/app/ventas/42/pagos" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "monto": -100.00,
    "tipo_pago": "TRANSFERENCIA"
  }'
```

**Resultado esperado:** ‚ùå Error 422
```json
{
  "success": false,
  "message": "El monto debe ser mayor a 0"
}
```

### Test 2: Validaci√≥n - Monto superior al pendiente
```bash
curl -X POST "http://localhost:8000/api/app/ventas/42/pagos" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "monto": 2000.00,
    "tipo_pago": "TRANSFERENCIA"
  }'
```

**Resultado esperado:** ‚ùå Error 422
```json
{
  "success": false,
  "message": "El monto a pagar no puede exceder el monto pendiente",
  "monto_pendiente": 1500.00,
  "monto_solicitado": 2000.00,
  "diferencia": 500.00
}
```

### Test 3: ‚úÖ √âXITO - Pago parcial (50%)
```bash
curl -X POST "http://localhost:8000/api/app/ventas/42/pagos" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "monto": 750.00,
    "tipo_pago": "TRANSFERENCIA",
    "numero_referencia": "TRF-20251025-001",
    "observaciones": "Primer pago del pedido"
  }'
```

**Resultado esperado:** ‚úÖ Success 201
```json
{
  "success": true,
  "message": "Pago de 750 registrado exitosamente",
  "data": {
    "pago": {
      "id": 5,
      "monto": 750.00,
      "tipo_pago": "TRANSFERENCIA",
      "numero_referencia": "TRF-20251025-001",
      "fecha": "2025-10-25 14:30:45"
    },
    "venta_actualizada": {
      "id": 42,
      "numero": "V-2025-00042",
      "monto_total": 1500.00,
      "monto_pagado": 750.00,
      "monto_pendiente": 750.00,
      "estado_pago": "PARCIALMENTE_PAGADO",
      "porcentaje_pagado": 50.0
    }
  }
}
```

### Test 4: ‚úÖ √âXITO - Pago complementario (50% restante)
```bash
curl -X POST "http://localhost:8000/api/app/ventas/42/pagos" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "monto": 750.00,
    "tipo_pago": "TRANSFERENCIA",
    "numero_referencia": "TRF-20251025-002",
    "observaciones": "Segundo y √∫ltimo pago"
  }'
```

**Resultado esperado:** ‚úÖ Success 201
```json
{
  "success": true,
  "message": "Pago de 750 registrado exitosamente",
  "data": {
    "venta_actualizada": {
      "monto_pagado": 1500.00,
      "monto_pendiente": 0.00,
      "estado_pago": "PAGADO",
      "porcentaje_pagado": 100.0
    }
  }
}
```

---

## üöö PASO 5: VALIDACI√ìN DE PAGO PARA ENV√çO

### Test 1: Pol√≠tica ANTICIPADO_100 sin 100% pago
Crear venta con `politica_pago: "ANTICIPADO_100"` sin pagar nada.

Intentar programar env√≠o ‚Üí **‚ùå Error:** "Requiere pago 100% anticipado"

### Test 2: Pol√≠tica MEDIO_MEDIO con menos del 50%
Pagar solo 30% de venta con `politica_pago: "MEDIO_MEDIO"`

Intentar programar env√≠o ‚Üí **‚ùå Error:** "Requiere m√≠nimo 50% pagado"

### Test 3: Pol√≠tica MEDIO_MEDIO con 50% pagado
Pagar exactamente 50% ‚Üí **‚úÖ Env√≠o programado exitosamente**

### Test 4: Pol√≠tica CONTRA_ENTREGA sin pago
No pagar nada con `politica_pago: "CONTRA_ENTREGA"`

Programar env√≠o ‚Üí **‚úÖ Env√≠o programado sin validaci√≥n**

---

## üìä POSTMAN COLLECTION

Importar esta colecci√≥n en Postman:

```json
{
  "info": {
    "name": "API Paucara - Pagos y Confirmaci√≥n",
    "version": "1.0"
  },
  "item": [
    {
      "name": "1. Login",
      "request": {
        "method": "POST",
        "url": "http://localhost:8000/api/login",
        "body": {
          "monto": {
            "email": "juan.perez@paucara.test",
            "password": "password123"
          }
        }
      }
    },
    {
      "name": "2. Crear Proforma",
      "request": {
        "method": "POST",
        "url": "http://localhost:8000/api/app/pedidos",
        "header": {
          "Authorization": "Bearer {{token}}"
        },
        "body": {
          "items": [
            {"producto_id": 1, "cantidad": 5}
          ]
        }
      }
    },
    {
      "name": "3. Confirmar Proforma",
      "request": {
        "method": "POST",
        "url": "http://localhost:8000/api/app/proformas/{{proforma_id}}/confirmar",
        "header": {
          "Authorization": "Bearer {{token}}"
        },
        "body": {
          "politica_pago": "MEDIO_MEDIO"
        }
      }
    },
    {
      "name": "4. Registrar Pago",
      "request": {
        "method": "POST",
        "url": "http://localhost:8000/api/app/ventas/{{venta_id}}/pagos",
        "header": {
          "Authorization": "Bearer {{token}}"
        },
        "body": {
          "monto": 750.00,
          "tipo_pago": "TRANSFERENCIA"
        }
      }
    }
  ]
}
```

---

## ‚úÖ CHECKLIST DE TESTING

- [ ] **Login exitoso** con usuario cliente
- [ ] **Crear proforma** con 5+ productos
- [ ] **Aprobar proforma** desde dashboard
- [ ] **Confirmar proforma** ‚Üí Crear venta
  - [ ] Validaci√≥n: Proforma no aprobada
  - [ ] Validaci√≥n: Menos de 5 productos
  - [ ] √âxito: Venta creada con estado_pago=PENDIENTE
- [ ] **Registrar pagos**
  - [ ] Validaci√≥n: Monto negativo
  - [ ] Validaci√≥n: Monto > pendiente
  - [ ] √âxito: Pago parcial (50%)
  - [ ] √âxito: Pago complementario (100%)
  - [ ] Verificar: estado_pago actualizado
- [ ] **Validaci√≥n de pago para env√≠o**
  - [ ] ANTICIPADO_100: Rechaza sin 100% pago
  - [ ] MEDIO_MEDIO: Rechaza con < 50% pago
  - [ ] MEDIO_MEDIO: Permite con ‚â• 50% pago
  - [ ] CONTRA_ENTREGA: Permite sin pago

---

## üîç LOGS DE REFERENCIA

Ver logs en `storage/logs/laravel.log`:

```bash
tail -f storage/logs/laravel.log
```

Buscar informaci√≥n de:
- Proforma confirmada: `Proforma confirmada como venta`
- Pago registrado: `Pago registrado en venta`
- Validaci√≥n de env√≠o: `Venta requiere`

---

## üìû TROUBLESHOOTING

| Problema | Soluci√≥n |
|----------|----------|
| 401 Unauthorized | Token expirado o inv√°lido. Hacer login nuevamente |
| 404 Not Found | Proforma/Venta no existe. Verificar IDs |
| 422 Validation Error | Par√°metros inv√°lidos. Revisar request body |
| Proforma no aprobada | Ir a Dashboard ‚Üí Proformas ‚Üí Aprobar |
| Stock insuficiente | Verificar disponibilidad de productos |
| No hay reservas activas | La proforma debe tener stock reservado |

---

## üéØ PR√ìXIMOS PASOS

Despu√©s de verificar todos los tests:

1. ‚úÖ Exportar Postman Collection
2. ‚úÖ Crear documento de ejemplos JSON
3. ‚úÖ Compartir con equipo Flutter
4. üöÄ Flutter comienza integraci√≥n

---

**Estado:** üü¢ LISTO PARA TESTING
**Fecha:** 2025-10-25
**Documentaci√≥n:** Completa y verificada

