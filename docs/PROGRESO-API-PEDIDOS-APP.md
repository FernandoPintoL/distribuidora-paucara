# üì± API de Pedidos para App de Clientes - Progreso de Implementaci√≥n

## Estado General del Proyecto

**Fecha de inicio**: 17 de Octubre, 2025
**√öltima actualizaci√≥n**: 17 de Octubre, 2025

---

## üéØ Objetivo General

Desarrollar una API REST completa y optimizada para que los clientes puedan crear y gestionar pedidos desde una aplicaci√≥n m√≥vil Flutter, con funcionalidades de reserva de stock, seguimiento de pedidos y gesti√≥n de direcciones de entrega.

---

## ‚úÖ FASE 1: ENDPOINTS B√ÅSICOS DE PEDIDOS

### ‚úÖ FASE 1.1: Crear Pedidos desde la App
**Estado**: ‚úÖ **COMPLETADO**
**Fecha de completaci√≥n**: 17 de Octubre, 2025

#### Implementaci√≥n Realizada

**Endpoint creado**:
- `POST /api/app/pedidos` ‚Üí `ApiProformaController@crearPedidoDesdeApp`

**Ubicaci√≥n en c√≥digo**:
- Controlador: `app/Http/Controllers/Api/ApiProformaController.php:470-708`
- Ruta: `routes/api.php:72`

**Caracter√≠sticas implementadas**:
- ‚úÖ Autenticaci√≥n autom√°tica del cliente (v√≠a Sanctum)
- ‚úÖ Validaci√≥n de items (productos y cantidades)
- ‚úÖ Validaci√≥n de direcci√≥n de entrega
  - Usa direcci√≥n especificada o la principal del cliente
  - Verifica que la direcci√≥n est√© activa y pertenezca al cliente
- ‚úÖ Verificaci√≥n de stock disponible
  - Retorna detalles de stock insuficiente si aplica
- ‚úÖ Validaci√≥n de productos activos y con precio
- ‚úÖ C√°lculo autom√°tico de totales
  - Subtotal
  - Impuesto (13% IVA Bolivia)
  - Total
- ‚úÖ Creaci√≥n autom√°tica de proforma
- ‚úÖ **Reserva autom√°tica de stock**
- ‚úÖ Respuesta optimizada para app m√≥vil con:
  - Datos del pedido
  - Informaci√≥n de direcci√≥n de entrega
  - Estado de reservas de stock

**Validaciones**:
```php
- items: required|array|min:1
- items.*.producto_id: required|exists:productos,id
- items.*.cantidad: required|numeric|min:0.01
- direccion_id: nullable|exists:direcciones_cliente,id
- observaciones: nullable|string|max:1000
```

**Casos de error manejados**:
- ‚ùå Usuario sin cliente asociado (403)
- ‚ùå Direcci√≥n no existe o no pertenece al cliente (422)
- ‚ùå Cliente sin direcciones configuradas (422)
- ‚ùå Stock insuficiente con detalle de faltantes (422)
- ‚ùå Producto inactivo (422)
- ‚ùå Producto sin precio (422)
- ‚ùå Error al reservar stock (422)
- ‚ùå Errores de validaci√≥n (422)
- ‚ùå Errores del servidor (500)

**Archivo de pruebas**:
- `docs/api-tests/crear-pedido-app.http` (11 casos de prueba)

---

### ‚úÖ FASE 1.2: Endpoints de Consulta
**Estado**: ‚úÖ **COMPLETADO**
**Fecha de completaci√≥n**: 17 de Octubre, 2025

#### Implementaci√≥n Realizada

**Endpoints creados**:

#### 1. Historial de Pedidos
- `GET /api/app/cliente/pedidos` ‚Üí `ApiProformaController@obtenerHistorialPedidos`

**Ubicaci√≥n**: `ApiProformaController.php:728-833`
**Ruta**: `routes/api.php:75`

**Caracter√≠sticas**:
- ‚úÖ Paginaci√≥n personalizable (default: 15, max: 50 items)
- ‚úÖ Filtros disponibles:
  - `estado`: PENDIENTE, APROBADA, RECHAZADA, CONVERTIDA_A_VENTA
  - `fecha_desde`: formato Y-m-d
  - `fecha_hasta`: formato Y-m-d (debe ser >= fecha_desde)
  - `page`: n√∫mero de p√°gina
  - `per_page`: items por p√°gina
- ‚úÖ Vista previa de items (primeros 3 productos)
- ‚úÖ Resumen estad√≠stico (total, pendientes, aprobados)
- ‚úÖ Informaci√≥n de reservas activas

**Respuesta incluye**:
```json
{
  "pedidos": [...],
  "paginacion": {
    "total": 10,
    "por_pagina": 15,
    "pagina_actual": 1,
    "ultima_pagina": 1,
    "desde": 1,
    "hasta": 10
  },
  "resumen": {
    "total_pedidos": 10,
    "pendientes": 3,
    "aprobados": 5
  }
}
```

---

#### 2. Detalle Completo de Pedido
- `GET /api/app/pedidos/{id}` ‚Üí `ApiProformaController@obtenerDetallePedido`

**Ubicaci√≥n**: `ApiProformaController.php:846-960`
**Ruta**: `routes/api.php:78`

**Caracter√≠sticas**:
- ‚úÖ Informaci√≥n completa del pedido
- ‚úÖ Lista de items con detalles de productos:
  - Nombre, c√≥digo, categor√≠a, marca
  - Unidad de medida
  - Cantidad, precio unitario, subtotal
  - Imagen del producto
- ‚úÖ Direcci√≥n de entrega completa
- ‚úÖ Estado de reservas de stock:
  - Cantidad de reservas
  - Fecha de expiraci√≥n
  - Tiempo restante en horas
  - Detalle por almac√©n
- ‚úÖ Informaci√≥n de seguimiento:
  - Usuario creador y fecha
  - Usuario aprobador y fecha
- ‚úÖ Permisos contextuales:
  - `puede_cancelar`
  - `puede_extender_reserva`

**Respuesta incluye**:
```json
{
  "pedido": {...},
  "items": [...],
  "direccion_entrega": {...},
  "reservas_stock": {...},
  "seguimiento": {...}
}
```

---

#### 3. Estado Actual del Pedido (Endpoint Ligero)
- `GET /api/app/pedidos/{id}/estado` ‚Üí `ApiProformaController@obtenerEstadoPedido`

**Ubicaci√≥n**: `ApiProformaController.php:973-1043`
**Ruta**: `routes/api.php:81`

**Caracter√≠sticas**:
- ‚úÖ Endpoint ultra-ligero sin relaciones
- ‚úÖ Solo campos esenciales del estado
- ‚úÖ Informaci√≥n para la UI:
  - Descripci√≥n amigable en espa√±ol
  - C√≥digo de color hexadecimal
  - Nombre de icono
- ‚úÖ Tiempo restante de reserva en horas
- ‚úÖ Ideal para actualizaciones r√°pidas/polling

**Helpers implementados**:
- `obtenerDescripcionEstado()`: Mensajes amigables
- `obtenerColorEstado()`: Colores para UI
- `obtenerIconoEstado()`: Iconos para UI

**Mapeo de estados**:
```php
PENDIENTE ‚Üí "Tu pedido est√° siendo revisado..." (#FFA500, clock)
APROBADA ‚Üí "Tu pedido ha sido aprobado..." (#4CAF50, check-circle)
RECHAZADA ‚Üí "Lo sentimos, tu pedido no pudo ser procesado" (#F44336, x-circle)
CONVERTIDA_A_VENTA ‚Üí "Tu pedido ha sido confirmado..." (#2196F3, truck)
```

**Respuesta incluye**:
```json
{
  "id": 1,
  "codigo": "PRO-20251017-0001",
  "estado": "PENDIENTE",
  "estado_detalle": {
    "descripcion": "...",
    "color": "#FFA500",
    "icono": "clock"
  },
  "reserva_info": {
    "fecha_expiracion": "2025-10-18 10:00:00",
    "tiempo_restante_horas": 22.5
  }
}
```

---

**Validaciones de seguridad** (todos los endpoints de consulta):
- ‚úÖ Usuario debe tener cliente asociado (403)
- ‚úÖ Solo puede ver sus propios pedidos (403)
- ‚úÖ Validaci√≥n de par√°metros de filtro (422)
- ‚úÖ Manejo de pedidos no encontrados (404)

**Archivo de pruebas**:
- `docs/api-tests/consultar-pedidos-app.http` (14 casos de prueba + flujo completo)

---

## üìã FASE 2: GESTI√ìN DE DIRECCIONES DE ENTREGA

### ‚è≥ FASE 2.1: CRUD de Direcciones
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `GET /api/app/cliente/direcciones` - Listar direcciones del cliente
- [ ] `POST /api/app/cliente/direcciones` - Crear nueva direcci√≥n
- [ ] `PUT /api/app/cliente/direcciones/{id}` - Actualizar direcci√≥n
- [ ] `DELETE /api/app/cliente/direcciones/{id}` - Eliminar direcci√≥n
- [ ] `PATCH /api/app/cliente/direcciones/{id}/establecer-principal` - Marcar como principal

#### Caracter√≠sticas pendientes:
- [ ] Validaci√≥n de coordenadas GPS (latitud/longitud)
- [ ] Validaci√≥n de que una direcci√≥n est√© marcada como principal
- [ ] Gesti√≥n de m√∫ltiples direcciones por cliente
- [ ] Validaci√≥n de permisos (solo sus propias direcciones)

---

### ‚è≥ FASE 2.2: Validaci√≥n de Direcciones
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `POST /api/app/validar-direccion` - Validar direcci√≥n con servicio de mapas
- [ ] `GET /api/app/geocodificar` - Convertir direcci√≥n a coordenadas

#### Caracter√≠sticas pendientes:
- [ ] Integraci√≥n con servicio de geocodificaci√≥n
- [ ] Validaci√≥n de zona de cobertura
- [ ] C√°lculo de distancia desde almacenes

---

## üìã FASE 3: CAT√ÅLOGO DE PRODUCTOS

### ‚è≥ FASE 3.1: Listar Productos Disponibles
**Estado**: ‚è≥ **PENDIENTE**

**Nota**: Ya existe endpoint b√°sico en `routes/api.php:89`:
```php
Route::get('/app/productos-disponibles', [ApiProformaController::class, 'obtenerProductosDisponibles']);
```

#### Mejoras pendientes:
- [ ] Optimizar respuesta para app m√≥vil
- [ ] Agregar filtros avanzados (precio, marca, categor√≠a)
- [ ] Implementar b√∫squeda por texto
- [ ] Agregar informaci√≥n de stock disponible
- [ ] Incluir im√°genes de productos
- [ ] Paginaci√≥n optimizada

---

### ‚è≥ FASE 3.2: Detalle de Producto
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `GET /api/app/productos/{id}` - Detalle completo del producto
- [ ] `GET /api/app/productos/{id}/stock` - Stock disponible por almac√©n

---

### ‚è≥ FASE 3.3: B√∫squeda y Filtros
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `GET /api/app/productos/buscar` - B√∫squeda por texto
- [ ] `GET /api/app/categorias` - Listar categor√≠as
- [ ] `GET /api/app/marcas` - Listar marcas

---

## üìã FASE 4: GESTI√ìN DE PEDIDOS AVANZADA

### ‚è≥ FASE 4.1: Cancelaci√≥n de Pedidos
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `POST /api/app/pedidos/{id}/cancelar` - Cancelar pedido pendiente
- [ ] Validar que solo se puedan cancelar pedidos en estado PENDIENTE
- [ ] Liberar autom√°ticamente las reservas de stock

---

### ‚è≥ FASE 4.2: Extensi√≥n de Reservas
**Estado**: ‚è≥ **PENDIENTE**

**Nota**: Ya existe endpoint b√°sico en `routes/api.php:61`:
```php
Route::post('/{proforma}/extender-reservas', [ApiProformaController::class, 'extenderReservas']);
```

#### Mejoras pendientes:
- [ ] Adaptar para uso desde la app del cliente
- [ ] Validar l√≠mite de extensiones permitidas
- [ ] Notificar al cliente cuando la reserva est√° por vencer

---

### ‚è≥ FASE 4.3: Modificaci√≥n de Pedidos
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `PUT /api/app/pedidos/{id}` - Modificar pedido pendiente
- [ ] Validar que solo se puedan modificar pedidos PENDIENTES
- [ ] Recalcular stock y totales
- [ ] Actualizar reservas de stock

---

## üìã FASE 5: NOTIFICACIONES Y SEGUIMIENTO

### ‚è≥ FASE 5.1: Sistema de Notificaciones
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `GET /api/app/notificaciones` - Listar notificaciones del cliente
- [ ] `POST /api/app/notificaciones/{id}/marcar-leida` - Marcar como le√≠da
- [ ] `POST /api/app/dispositivos/registrar` - Registrar token FCM para push

---

### ‚è≥ FASE 5.2: Seguimiento de Pedidos
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `GET /api/app/pedidos/{id}/seguimiento` - Timeline del pedido
- [ ] `GET /api/app/pedidos/{id}/ubicacion-envio` - Ubicaci√≥n del delivery

---

## üìã FASE 6: REPORTES Y ESTAD√çSTICAS

### ‚è≥ FASE 6.1: Estad√≠sticas del Cliente
**Estado**: ‚è≥ **PENDIENTE**

#### Endpoints a implementar:
- [ ] `GET /api/app/cliente/estadisticas` - Resumen de compras y pedidos
- [ ] `GET /api/app/cliente/historial-compras` - Historial completo

---

## üìä Resumen de Progreso

### Por Fase:
- ‚úÖ **Fase 1.1**: Crear Pedidos - **COMPLETADO**
- ‚úÖ **Fase 1.2**: Endpoints de Consulta - **COMPLETADO**
- ‚è≥ **Fase 2**: Gesti√≥n de Direcciones - **PENDIENTE**
- ‚è≥ **Fase 3**: Cat√°logo de Productos - **PENDIENTE**
- ‚è≥ **Fase 4**: Gesti√≥n Avanzada - **PENDIENTE**
- ‚è≥ **Fase 5**: Notificaciones - **PENDIENTE**
- ‚è≥ **Fase 6**: Reportes - **PENDIENTE**

### Estad√≠sticas:
- **Endpoints completados**: 4/30+ (‚âà13%)
- **Fases completadas**: 2/12 (‚âà17%)
- **Archivos de prueba**: 2 archivos HTTP con 25 casos de prueba

---

## üìÅ Estructura de Archivos Modificados/Creados

### Controladores
```
app/Http/Controllers/Api/
‚îî‚îÄ‚îÄ ApiProformaController.php (modificado)
    ‚îú‚îÄ‚îÄ crearPedidoDesdeApp() [l√≠nea 470-708]
    ‚îú‚îÄ‚îÄ obtenerHistorialPedidos() [l√≠nea 728-833]
    ‚îú‚îÄ‚îÄ obtenerDetallePedido() [l√≠nea 846-960]
    ‚îú‚îÄ‚îÄ obtenerEstadoPedido() [l√≠nea 973-1043]
    ‚îú‚îÄ‚îÄ obtenerDescripcionEstado() [l√≠nea 1048-1057]
    ‚îú‚îÄ‚îÄ obtenerColorEstado() [l√≠nea 1062-1071]
    ‚îî‚îÄ‚îÄ obtenerIconoEstado() [l√≠nea 1076-1085]
```

### Rutas
```
routes/
‚îî‚îÄ‚îÄ api.php (modificado)
    ‚îú‚îÄ‚îÄ POST /api/app/pedidos [l√≠nea 72]
    ‚îú‚îÄ‚îÄ GET /api/app/cliente/pedidos [l√≠nea 75]
    ‚îú‚îÄ‚îÄ GET /api/app/pedidos/{id} [l√≠nea 78]
    ‚îî‚îÄ‚îÄ GET /api/app/pedidos/{id}/estado [l√≠nea 81]
```

### Documentaci√≥n y Pruebas
```
docs/
‚îú‚îÄ‚îÄ PROGRESO-API-PEDIDOS-APP.md (este archivo)
‚îî‚îÄ‚îÄ api-tests/
    ‚îú‚îÄ‚îÄ crear-pedido-app.http (11 casos de prueba)
    ‚îî‚îÄ‚îÄ consultar-pedidos-app.http (14 casos de prueba)
```

---

## üîß Tecnolog√≠as Utilizadas

- **Framework**: Laravel (PHP)
- **Autenticaci√≥n**: Laravel Sanctum
- **Base de datos**: PostgreSQL
- **Validaci√≥n**: FormRequest Validator
- **Transacciones**: DB::beginTransaction()
- **Testing**: REST Client (VS Code)

---

## üìù Notas Importantes

### Caracter√≠sticas Destacadas Implementadas:

1. **Reserva Autom√°tica de Stock**:
   - Al crear un pedido, el stock se reserva autom√°ticamente
   - Las reservas tienen fecha de expiraci√≥n
   - Se puede verificar el tiempo restante de reserva

2. **Validaciones de Seguridad**:
   - Todos los endpoints verifican que el usuario tenga un cliente asociado
   - Los clientes solo pueden ver/modificar sus propios pedidos
   - Validaci√≥n de permisos a nivel de direcci√≥n de entrega

3. **Optimizaci√≥n para App M√≥vil**:
   - Respuestas con solo los datos necesarios
   - Endpoint ligero (`/estado`) para actualizaciones r√°pidas
   - Paginaci√≥n eficiente
   - Helpers de UI (colores, iconos, descripciones)

4. **Manejo de Errores Robusto**:
   - C√≥digos HTTP apropiados (200, 201, 403, 404, 422, 500)
   - Mensajes de error descriptivos en espa√±ol
   - Detalles de validaci√≥n cuando aplica
   - Logging de errores del servidor

---

## üöÄ Siguiente Paso Recomendado

**FASE 2.1**: Implementar CRUD de Direcciones de Entrega

Esto complementar√° la funcionalidad de pedidos, permitiendo que los clientes gestionen sus direcciones directamente desde la app.

---

## üìû Informaci√≥n de Contacto del Proyecto

- **Proyecto**: Distribuidora Paucara
- **M√≥dulo**: API de Pedidos para App de Clientes
- **Desarrolladores**: Claude Code + Equipo de Desarrollo

---

**√öltima actualizaci√≥n**: 17 de Octubre, 2025
