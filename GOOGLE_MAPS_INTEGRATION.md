# Integraci√≥n de Google Maps en Distribuidora Paucara

## üìç Descripci√≥n General

Este documento describe la integraci√≥n de Google Maps API en la aplicaci√≥n para:
- **Registro de coordenadas** de clientes, proveedores y empleados
- **Visualizaci√≥n de rutas** para log√≠stica y entregas
- **Geocodificaci√≥n** (direcci√≥n ‚Üî coordenadas)
- **C√°lculo de distancias** y tiempos de viaje

---

## üîß Configuraci√≥n Inicial

### 1. Variables de Entorno

Ya est√° configurado en tu `.env`:

```env
# Google Maps API
GOOGLE_MAPS_API_KEY=AIzaSyBfD5uDkc4vJcd7on1yFBJVdgmYV5XTrHA
VITE_GOOGLE_MAPS_API_KEY="${GOOGLE_MAPS_API_KEY}"
```

### 2. Librer√≠a Instalada

```bash
npm install @vis.gl/react-google-maps
```

Esta es la librer√≠a oficial y moderna de Google para React.

---

## üì¶ Componentes Disponibles

### 1. **MapPicker** - Selector de Coordenadas

Permite seleccionar ubicaciones en el mapa mediante:
- Clic directo en el mapa
- B√∫squeda de direcciones
- Geocodificaci√≥n inversa (coordenadas ‚Üí direcci√≥n)

**Ubicaci√≥n:** `resources/js/presentation/components/maps/MapPicker.tsx`

**Caracter√≠sticas:**
- ‚úÖ B√∫squeda de direcciones con autocompletado
- ‚úÖ Geocodificaci√≥n inversa autom√°tica
- ‚úÖ Validaci√≥n de coordenadas
- ‚úÖ Soporte para modo disabled
- ‚úÖ Personalizaci√≥n de altura y estilo
- ‚úÖ Manejo de errores

**Ejemplo de uso:**

```tsx
import MapPicker from '@/presentation/components/maps/MapPicker';

<MapPicker
    latitude={-17.78629}
    longitude={-63.18117}
    onLocationSelect={(lat, lng, address) => {
        console.log('Coordenadas:', lat, lng);
        console.log('Direcci√≥n:', address);
    }}
    label="Ubicaci√≥n del cliente"
    description="Selecciona la ubicaci√≥n exacta"
    disabled={false}
    height="400px"
/>
```

### 2. **RouteMap** - Visualizaci√≥n de Rutas

Muestra rutas optimizadas entre m√∫ltiples puntos con informaci√≥n de distancia y duraci√≥n.

**Ubicaci√≥n:** `resources/js/presentation/components/maps/RouteMap.tsx`

**Caracter√≠sticas:**
- ‚úÖ C√°lculo autom√°tico de rutas
- ‚úÖ Optimizaci√≥n de puntos intermedios
- ‚úÖ Distancia y tiempo estimado
- ‚úÖ Marcadores personalizados por tipo
- ‚úÖ Soporte para m√∫ltiples waypoints
- ‚úÖ Informaci√≥n detallada de cada punto

**Ejemplo de uso:**

```tsx
import RouteMap, { RoutePoint } from '@/presentation/components/maps/RouteMap';

const puntos: RoutePoint[] = [
    {
        id: 1,
        name: 'Distribuidora Paucara',
        latitude: -17.78629,
        longitude: -63.18117,
        type: 'origin',
        description: 'Punto de partida'
    },
    {
        id: 2,
        name: 'Cliente A',
        latitude: -17.79000,
        longitude: -63.19000,
        type: 'waypoint',
        description: 'Primera parada'
    },
    {
        id: 3,
        name: 'Cliente B',
        latitude: -17.80000,
        longitude: -63.20000,
        type: 'destination',
        description: 'Destino final'
    }
];

<RouteMap
    points={puntos}
    showRoute={true}
    showDistance={true}
    showDuration={true}
    optimizeRoute={true}
    height="600px"
    onRouteCalculated={(distance, duration) => {
        console.log('Distancia total:', distance, 'metros');
        console.log('Duraci√≥n total:', duration, 'segundos');
    }}
/>
```

---

## ü™ù Hook Personalizado

### **useGoogleMaps**

Hook que facilita operaciones comunes con Google Maps.

**Ubicaci√≥n:** `resources/js/hooks/use-google-maps.ts`

**Funciones disponibles:**

```tsx
import { useGoogleMaps } from '@/hooks/use-google-maps';

const {
    // Estados
    isLoading,
    error,

    // Funciones
    geocodeAddress,        // Direcci√≥n ‚Üí Coordenadas
    reverseGeocode,        // Coordenadas ‚Üí Direcci√≥n
    calculateDistance,     // Distancia entre 2 puntos
    calculateRoute,        // Ruta completa con waypoints
    getCurrentLocation,    // Ubicaci√≥n actual del navegador
    validateCoordinates,   // Validar coordenadas
    formatCoordinates     // Formatear para display
} = useGoogleMaps();
```

**Ejemplos de uso:**

```tsx
// 1. Geocodificar una direcci√≥n
const coords = await geocodeAddress('Av. Cristo Redentor, Santa Cruz');
// Retorna: { latitude: -17.78629, longitude: -63.18117 }

// 2. Geocodificaci√≥n inversa
const address = await reverseGeocode(-17.78629, -63.18117);
// Retorna: { formattedAddress: 'Av. Cristo Redentor...', city: 'Santa Cruz', ... }

// 3. Calcular distancia
const distancia = calculateDistance(
    { latitude: -17.78629, longitude: -63.18117 },
    { latitude: -17.79000, longitude: -63.19000 }
);
// Retorna: 1234.56 (metros)

// 4. Calcular ruta completa
const ruta = await calculateRoute(
    { latitude: -17.78629, longitude: -63.18117 }, // origen
    { latitude: -17.80000, longitude: -63.20000 }, // destino
    [
        { latitude: -17.79000, longitude: -63.19000 }, // waypoint 1
    ],
    true // optimizar
);
// Retorna: { distance: 5432, duration: 780, distanceText: '5.43 km', durationText: '13 min' }

// 5. Obtener ubicaci√≥n actual
const ubicacion = await getCurrentLocation();
// Retorna: { latitude: -17.78629, longitude: -63.18117 }
```

---

## üéØ Integraci√≥n en Formularios

El MapPicker ya est√° integrado en los formularios de:
- ‚úÖ **Clientes** (`resources/js/config/clientes.config.ts`)
- ‚úÖ **Proveedores** (`resources/js/config/proveedores.config.ts`)
- ‚úÖ **Empleados** (`resources/js/config/empleados.config.ts`)

### C√≥mo funciona

Cuando creas o editas un cliente, proveedor o empleado, encontrar√°s un campo **"Ubicaci√≥n en el mapa"** que:

1. Muestra un mapa interactivo
2. Permite buscar direcciones
3. Permite hacer clic en el mapa para seleccionar
4. Guarda autom√°ticamente `latitud` y `longitud` en la base de datos

**Nota importante:** Los campos `latitud` y `longitud` se manejan autom√°ticamente. El componente `MapPicker` actualiza ambos campos cuando seleccionas una ubicaci√≥n.

---

## üíº Casos de Uso para Log√≠stica

### 1. Planificaci√≥n de Rutas de Entrega

```tsx
import RouteMap from '@/presentation/components/maps/RouteMap';

// En tu componente de planificaci√≥n de entregas
const entregas = [
    { id: 'origen', name: 'Distribuidora', lat: -17.78, lng: -63.18, type: 'origin' },
    ...clientesDelDia.map(c => ({
        id: c.id,
        name: c.nombre,
        latitude: c.latitud,
        longitude: c.longitud,
        type: 'waypoint',
        description: c.direccion
    })),
    { id: 'destino', name: 'Retorno', lat: -17.78, lng: -63.18, type: 'destination' }
];

<RouteMap
    points={entregas}
    optimizeRoute={true}
    onRouteCalculated={(distance, duration) => {
        // Guardar informaci√≥n de la ruta
        setDistanciaTotal(distance);
        setTiempoEstimado(duration);
    }}
/>
```

### 2. Asignaci√≥n de Clientes por Zona

```tsx
import { useGoogleMaps } from '@/hooks/use-google-maps';

const { calculateDistance } = useGoogleMaps();

// Asignar clientes al repartidor m√°s cercano
const asignarRepartidor = (cliente) => {
    const distancias = repartidores.map(r => ({
        repartidor: r,
        distancia: calculateDistance(
            { latitude: r.latitud, longitude: r.longitud },
            { latitude: cliente.latitud, longitude: cliente.longitud }
        )
    }));

    // Ordenar por distancia y asignar al m√°s cercano
    const masCercano = distancias.sort((a, b) => a.distancia - b.distancia)[0];
    return masCercano.repartidor;
};
```

### 3. C√°lculo de Costos por Distancia

```tsx
const { calculateRoute } = useGoogleMaps();

const calcularCostoEntrega = async (origen, destino) => {
    const ruta = await calculateRoute(origen, destino);

    if (ruta) {
        const kmRecorridos = ruta.distance / 1000; // metros a km
        const costoPorKm = 5; // Bs. por km
        const costoTotal = kmRecorridos * costoPorKm;

        return {
            distancia: ruta.distanceText,
            tiempo: ruta.durationText,
            costo: costoTotal.toFixed(2) + ' Bs.'
        };
    }
};
```

---

## üé® Personalizaci√≥n

### Cambiar Centro del Mapa por Defecto

Edita en `MapPicker.tsx` o `RouteMap.tsx`:

```tsx
const DEFAULT_CENTER = { lat: -17.78629, lng: -63.18117 }; // Santa Cruz
const DEFAULT_ZOOM = 13;
```

### Estilos de Marcadores

En `RouteMap.tsx`, funci√≥n `getPinColor`:

```tsx
const getPinColor = (type?: string) => {
    switch (type) {
        case 'origin': return { background: '#22c55e', borderColor: '#16a34a' }; // Verde
        case 'destination': return { background: '#ef4444', borderColor: '#dc2626' }; // Rojo
        case 'waypoint': return { background: '#f59e0b', borderColor: '#d97706' }; // Amarillo
        default: return { background: '#2563eb', borderColor: '#1e40af' }; // Azul
    }
};
```

---

## üìä Migraciones Necesarias

Aseg√∫rate de que las tablas tengan los campos necesarios:

```sql
-- Para clientes
ALTER TABLE clientes ADD COLUMN latitud DECIMAL(10, 8) NULL;
ALTER TABLE clientes ADD COLUMN longitud DECIMAL(11, 8) NULL;

-- Para proveedores
ALTER TABLE proveedores ADD COLUMN latitud DECIMAL(10, 8) NULL;
ALTER TABLE proveedores ADD COLUMN longitud DECIMAL(11, 8) NULL;

-- Para empleados
ALTER TABLE empleados ADD COLUMN latitud DECIMAL(10, 8) NULL;
ALTER TABLE empleados ADD COLUMN longitud DECIMAL(11, 8) NULL;
```

---

## üöÄ Pr√≥ximas Mejoras Sugeridas

1. **Geocerca (Geofencing)**: Alertas cuando empleados entran/salen de zonas
2. **Tracking en Tiempo Real**: Seguimiento de veh√≠culos con GPS
3. **Heatmap de Ventas**: Mapa de calor con zonas m√°s vendidas
4. **Cluster de Marcadores**: Agrupar clientes cercanos
5. **Integraci√≥n con Waze/Google Maps**: Abrir rutas en app nativa

---

## üîê Seguridad

**Restricciones de API Key:**

Es importante que configures restricciones en tu Google Cloud Console:

1. Ve a [Google Cloud Console](https://console.cloud.google.com/)
2. API & Services ‚Üí Credentials
3. Edita tu API Key
4. En "Application restrictions" ‚Üí selecciona "HTTP referrers"
5. Agrega tus dominios permitidos:
   - `http://localhost:*`
   - `http://192.168.1.23:*`
   - `https://tupucara.com/*` (cuando vayas a producci√≥n)

---

## üìù Notas Importantes

1. **L√≠mites de la API gratuita**:
   - 28,000 cargas de mapa por mes gratis
   - $200 USD de cr√©dito mensual

2. **APIs habilitadas requeridas**:
   - Maps JavaScript API
   - Geocoding API
   - Directions API
   - Places API (opcional)

3. **Performance**:
   - Los componentes est√°n optimizados con memoizaci√≥n
   - La librer√≠a `@vis.gl/react-google-maps` es muy eficiente

---

## üêõ Troubleshooting

### Error: "Google Maps API key no configurada"

**Soluci√≥n:** Verifica que `VITE_GOOGLE_MAPS_API_KEY` est√© en tu `.env` y reinicia el servidor de desarrollo (`npm run dev`).

### Error: "This API project is not authorized to use this API"

**Soluci√≥n:** Habilita las APIs necesarias en Google Cloud Console (Maps JavaScript API, Geocoding API, Directions API).

### El mapa se muestra gris

**Soluci√≥n:** Revisa la consola del navegador. Puede ser:
- API Key inv√°lida
- Restricciones de dominio muy estrictas
- Billing no configurado en Google Cloud

---

## üìö Recursos Adicionales

- [Documentaci√≥n oficial de @vis.gl/react-google-maps](https://visgl.github.io/react-google-maps/)
- [Google Maps Platform](https://developers.google.com/maps)
- [Geocoding API Docs](https://developers.google.com/maps/documentation/geocoding)
- [Directions API Docs](https://developers.google.com/maps/documentation/directions)

---

**Creado para Distribuidora Paucara**
**Fecha:** $(date)
**Versi√≥n:** 1.0.0
