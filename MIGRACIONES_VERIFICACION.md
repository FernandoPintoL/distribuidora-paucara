# üîç VERIFICACI√ìN DE MIGRACIONES - Estado Real

**Fecha:** 2025-10-25
**Prop√≥sito:** Confirmar qu√© migraciones existen y cu√°les NO

---

## ‚úÖ MIGRACIONES QUE EXISTEN (CREADAS)

### 1. Tabla `envios` - EXISTE ‚úÖ

**Archivo:** `2025_09_11_150708_create_envios_table.php`
**Creada:** 11 de Septiembre
**Estado:** Migraci√≥n base creada

**Campos:**
- id, numero_envio, venta_id, vehiculo_id, chofer_id
- fecha_programada, fecha_salida, fecha_entrega
- estado (PROGRAMADO, EN_PREPARACION, EN_RUTA, ENTREGADO, CANCELADO)
- direccion_entrega, coordenadas_lat, coordenadas_lng
- observaciones, foto_entrega, firma_cliente
- receptor_nombre, receptor_documento
- timestamps

### 2. Tabla `pagos` - EXISTE ‚úÖ

**Archivo:** `2025_09_09_042245_create_pagos_table.php`
**Creada:** 9 de Septiembre
**Estado:** Migraci√≥n base creada

**Campos:**
- id, venta_id, tipo_pago_id, moneda_id
- monto, fecha, numero_transaccion
- observaciones, timestamps

**Nota:** Esta tabla es para pagos en general (compatible con CuentaPorPagar tambi√©n)

### 3. Campos para Rechazo de Entregas - EXISTE ‚úÖ

**Archivo:** `2025_10_25_030126_add_rejection_fields_to_envios_table.php`
**Creada:** 25 de Octubre (HOY)
**Estado:** Migraci√≥n CREADA pero POSIBLEMENTE NO EJECUTADA

**Campos agregados a tabla `envios`:**
```php
$table->string('estado_entrega')->nullable();      // EXITOSA, CLIENTE_AUSENTE, TIENDA_CERRADA, OTRO_PROBLEMA
$table->text('motivo_rechazo')->nullable();        // Descripci√≥n del rechazo
$table->json('fotos_rechazo')->nullable();         // Array JSON de rutas
$table->dateTime('fecha_intento_entrega')->nullable();
```

**√çndices:**
- estado_entrega
- fecha_intento_entrega

---

## ‚ùå MIGRACIONES QUE NO EXISTEN (FALTA CREAR)

### 1. Agregar Campos de Pago a `ventas` - NO EXISTE ‚ùå

**Archivo necesario:** `2025_10_25_add_payment_fields_to_ventas_table.php` (NO CREADO)

**Campos que necesitan agregarse:**
```php
$table->decimal('monto_pagado', 12, 2)->default(0);
$table->decimal('monto_pendiente', 12, 2)->default(0);
$table->string('politica_pago')->default('CONTRA_ENTREGA');  // ANTICIPADO_100, MEDIO_MEDIO, CONTRA_ENTREGA
$table->string('estado_pago')->default('PENDIENTE');         // PENDIENTE, PARCIALMENTE_PAGADO, PAGADO
```

**Estado:** ‚è≥ DEBE CREARSE E IMPLEMENTARSE

---

## üìä TABLA RESUMEN

| Migraci√≥n | Archivo | Existe | Ejecutada | Nota |
|-----------|---------|--------|-----------|------|
| **Tabla ventas** | `2025_09_09_025536_create_ventas_table.php` | ‚úÖ | ‚úÖ Asumido | Base creada |
| **Tabla pagos** | `2025_09_09_042245_create_pagos_table.php` | ‚úÖ | ‚úÖ Asumido | Base creada |
| **Tabla envios** | `2025_09_11_150708_create_envios_table.php` | ‚úÖ | ‚úÖ Asumido | Base creada |
| **Rechazo entregas** | `2025_10_25_030126_add_rejection_fields_to_envios_table.php` | ‚úÖ | ‚ùì DUDOSO | Archivo existe pero NO sabemos si se ejecut√≥ |
| **Pagos en ventas** | `2025_10_25_add_payment_fields_to_ventas_table.php` | ‚ùå | ‚ùå NO | NO EXISTE - DEBE CREARSE |

---

## üö® VERIFICACI√ìN CR√çTICA

### ¬øSe ejecut√≥ la migraci√≥n de rechazo?

Para verificar si la migraci√≥n de rechazo fue ejecutada, necesitar√≠as conectarte a la BD y verificar:

```sql
DESCRIBE envios;
-- O
SHOW COLUMNS FROM envios;
```

Si ves estas columnas, fue ejecutada:
- ‚úÖ `estado_entrega`
- ‚úÖ `motivo_rechazo`
- ‚úÖ `fotos_rechazo`
- ‚úÖ `fecha_intento_entrega`

Si NO ves estas columnas, fue CREADA pero NO ejecutada.

---

## üìã ESTADO ACTUAL

### Migraci√≥n de Rechazo (Hoy creada)

```
Archivo: ‚úÖ EXISTE
Contenido: ‚úÖ CORRECTO
Ejecutada: ‚ùì DESCONOCIDO (Probablemente NO)
```

**Para ejecutarla:**
```bash
cd D:\paucara\distribuidora-paucara
php artisan migrate
```

### Migraci√≥n de Pagos en Ventas

```
Archivo: ‚ùå NO EXISTE
Contenido: ‚è≥ NECESITA CREARSE
Ejecutada: ‚ùå NO
```

**Debe crearse as√≠:**

1. Crear archivo de migraci√≥n:
```bash
php artisan make:migration add_payment_fields_to_ventas_table
```

2. Agregar c√≥digo:
```php
public function up(): void
{
    Schema::table('ventas', function (Blueprint $table) {
        $table->decimal('monto_pagado', 12, 2)->default(0);
        $table->decimal('monto_pendiente', 12, 2)->default(0);
        $table->string('politica_pago')->default('CONTRA_ENTREGA');
        $table->string('estado_pago')->default('PENDIENTE');

        $table->index('estado_pago');
        $table->index(['cliente_id', 'estado_pago']);
    });
}

public function down(): void
{
    Schema::table('ventas', function (Blueprint $table) {
        $table->dropIndex(['estado_pago']);
        $table->dropIndex(['cliente_id', 'estado_pago']);
        $table->dropColumn([
            'monto_pagado',
            'monto_pendiente',
            'politica_pago',
            'estado_pago'
        ]);
    });
}
```

3. Ejecutar:
```bash
php artisan migrate
```

---

## üéØ CONCLUSI√ìN

| Tarea | Estado |
|-------|--------|
| **Migraci√≥n rechazo entregas** | ‚úÖ Archivo listo, ‚ùì Necesita ejecutar |
| **Migraci√≥n pagos en ventas** | ‚ùå No existe, ‚è≥ Necesita crear + ejecutar |
| **Modelos actualizados** | ‚úÖ Venta.php y Envio.php listos |
| **Controladores** | ‚úÖ EnvioController::rechazarEntrega() listo, ‚è≥ Endpoints de pago pendientes |
| **Rutas API** | ‚úÖ Rechazo listo, ‚è≥ Pagos pendientes |

---

## ‚úÖ PR√ìXIMOS PASOS INMEDIATOS

### AHORA (Hoy - 30 minutos)

```bash
# 1. Ejecutar la migraci√≥n de rechazo que ya existe
php artisan migrate

# 2. Verificar que los campos aparecieron
php artisan tinker
> Schema::getColumns('envios')
# Busca: estado_entrega, motivo_rechazo, fotos_rechazo, fecha_intento_entrega
```

### HOY (Primeras 4 horas)

```bash
# 3. Crear migraci√≥n de pagos
php artisan make:migration add_payment_fields_to_ventas_table

# 4. Editar el archivo creado (copiar c√≥digo arriba)

# 5. Ejecutar la migraci√≥n
php artisan migrate
```

### DESPU√âS (Siguientes 3 horas)

- Crear endpoints de confirmaci√≥n de proforma
- Crear endpoints de registro de pagos
- Validaciones

---

**Actualizaci√≥n:** 2025-10-25
**Verificado:** Archivos de migraciones en disco
**Pendiente:** Verificar si fueron ejecutadas en la BD
